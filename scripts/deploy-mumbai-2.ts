import hardhat from "hardhat";
const { waffle, ethers } = hardhat;
const { provider } = waffle;
const BN = ethers.BigNumber;
import { config as dotenv_config } from "dotenv";
dotenv_config();
const deployer = new ethers.Wallet(JSON.parse(process.env.RINKEBY_ACCOUNTS || '[]')[0], provider);

import { create2ContractPolygon } from "./create2ContractPolygon";

import { logContractAddress } from "./utils";

import { import_artifacts, ArtifactImports } from "./../test/utilities/artifact_importer";
import { Deployer, Solace, XsLocker, BondDepository, BondTellerErc20, BondTellerMatic, MockErc20, Wmatic } from "../typechain";
import { BytesLike, constants } from "ethers";
import { deployContract } from "ethereum-waffle";
import { expectDeployed, isDeployed } from "../test/utilities/expectDeployed";

const DEPLOYER_CONTRACT_ADDRESS    = "0x501aCe4732E4A80CC1bc5cd081BEe7f88ff694EF";

const BOND_START_TIME = BN.from("1638205200"); // 5 PM UTC November 29 2021
const MAX_UINT40 = BN.from("1099511627775");
const MAX_UINT128 = BN.from(1).shl(128).sub(1);
const ONE_ETHER = BN.from("1000000000000000000");

const SOLACE_ADDRESS                = "0x501acE9c35E60f03A2af4d484f49F9B1EFde9f40";
const XSLOCKER_ADDRESS              = "0x501Ace47c5b0C2099C4464f681c3fa2ECD3146C1";
const DAO_ADDRESS                   = "0x501aceB2Ff39b3aC0189ba1ACe497C3dAB486F7B";
const UNDERWRITING_POOL_ADDRESS     = "0x501ace27A074471F099ffFeC008Bd1b151c7F7dE";
const BOND_DEPO_ADDRESS             = "0x501ACe2f00EC599D4FDeA408680e192f88D94D0D";

const WMATIC_ADDRESS                = "0xaCCcDcEd4198c837d9A98E870F330697f94208f7";
const MATIC_BOND_TELLER_ADDRESS     = "0x501aCe133452D4Df83CA68C684454fCbA608b9DD";

const DAI_ADDRESS                   = "0x829F3bc2f95E190fcf75Cca9D53ECd873404AeA4";
const DAI_BOND_TELLER_ADDRESS       = "0x501ACe677634Fd09A876E88126076933b686967a";

const WETH_ADDRESS                  = "0xb11CD68Cebb89E8ED0733B2C46B333Fb7a51816E";
const WETH_BOND_TELLER_ADDRESS      = "0x501Ace367f1865DEa154236D5A8016B80a49e8a9";

const USDC_ADDRESS                  = "0xca08aB81e4E437AcDda0E7505026bdD9A97b8B76";
const USDC_BOND_TELLER_ADDRESS      = "0x501ACE7E977e06A3Cb55f9c28D5654C9d74d5cA9";

const WBTC_ADDRESS                  = "0x7aD1341d3f29Cd6694fF43e284502A9eD3048E20";
const WBTC_BOND_TELLER_ADDRESS      = "0x501aCEF0d0c73BD103337e6E9Fd49d58c426dC27";

const USDT_ADDRESS                  = "0x992fbE5C6fc9d5f09F4Fd85eF1FD331df078821C";
const USDT_BOND_TELLER_ADDRESS      = "0x501ACe5CeEc693Df03198755ee80d4CE0b5c55fE";

const FRAX_ADDRESS                  = "0xE338d08783CE3bdE2Cc03b137b196168641A8C05";
const FRAX_BOND_TELLER_ADDRESS      = "0x501aCef4F8397413C33B13cB39670aD2f17BfE62";

let artifacts: ArtifactImports;
let deployerContract: Deployer;

let solace: Solace;
let xslocker: XsLocker;
let bondDepo: BondDepository;

let wmatic: Wmatic;
let weth: MockErc20;
let dai: MockErc20;
let usdc: MockErc20;
let wbtc: MockErc20;
let usdt: MockErc20;
let frax: MockErc20;

let maticTeller: BondTellerMatic;
let daiTeller: BondTellerErc20;
let wethTeller: BondTellerErc20;
let usdcTeller: BondTellerErc20;
let wbtcTeller: BondTellerErc20;
let usdtTeller: BondTellerErc20;
let fraxTeller: BondTellerErc20;

let signerAddress: string;

async function main() {
  artifacts = await import_artifacts();
  signerAddress = await deployer.getAddress();
  console.log(`Using ${signerAddress} as deployer and governor`);

  if((await provider.getNetwork()).chainId == 31337) { // testnet
    console.log('funding')
    var [funder] = await hardhat.ethers.getSigners();
    let tx = await funder.sendTransaction({to: signerAddress, value: BN.from("100000000000000000000")});
    await tx.wait();
  }

  deployerContract = (await ethers.getContractAt(artifacts.Deployer.abi, DEPLOYER_CONTRACT_ADDRESS)) as Deployer;
  solace = (await ethers.getContractAt(artifacts.SOLACE.abi, SOLACE_ADDRESS)) as Solace;
  xslocker = (await ethers.getContractAt(artifacts.xsLocker.abi, XSLOCKER_ADDRESS)) as XsLocker;

  //await deployTestnetTokens();
  //await mintTestnetTokens();

  // new underwriting
  await deployBondDepo();

  await deployMaticTeller();
  await deployDaiTeller();
  await deployEthTeller();
  await deployUsdcTeller();
  await deployWbtcTeller();
  await deployUsdtTeller();
  await deployFraxTeller();

  await logAddresses();
}

async function deployBondDepo() {
  if(await isDeployed(BOND_DEPO_ADDRESS)) {
    bondDepo = (await ethers.getContractAt(artifacts.BondDepository.abi, BOND_DEPO_ADDRESS)) as BondDepository;
  } else {
    console.log("Deploying BondDepository");
    var res = await create2ContractPolygon(deployer,artifacts.BondDepository, [signerAddress, solace.address], {}, "", deployerContract.address);
    bondDepo = (await ethers.getContractAt(artifacts.BondDepository.abi, res.address)) as BondDepository;
    console.log(`Deployed BondDepository to ${bondDepo.address}`);

    if(!(await solace.isMinter(bondDepo.address)) && (await solace.governance() === (signerAddress))) {
      console.log("Adding bond depo as SOLACE minter");
      let tx = await solace.connect(deployer).addMinter(bondDepo.address);
      await tx.wait();
      console.log("Added bond depo as SOLACE minter");
    }
  }
}

async function deployMaticTeller() {
  const NAME = "Solace MATIC Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  //const ONE_CENT_IN_MATIC = BN.from("6666666666666667"); // @ 1 matic = $1.50
  //const ONE_TENTH_CENT_IN_MATIC = BN.from("666666666666667");
  const ONE_CENT_IN_MATIC = BN.from("6060606060606061"); // @ 1 matic = $1.65
  const ONE_TENTH_CENT_IN_MATIC = BN.from("606060606060606");

  const START_PRICE = ONE_CENT_IN_MATIC.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_MATIC;
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(MATIC_BOND_TELLER_ADDRESS)) {
    maticTeller = (await ethers.getContractAt(artifacts.BondTellerMATIC.abi, MATIC_BOND_TELLER_ADDRESS)) as BondTellerMatic;
  } else {
    console.log("MATIC Teller - deploy");
    var res = await create2ContractPolygon(deployer,artifacts.BondTellerMATIC, [], {}, "", deployerContract.address);
    maticTeller = (await ethers.getContractAt(artifacts.BondTellerMATIC.abi, res.address)) as BondTellerMatic;
    console.log(`MATIC Teller - deployed to ${maticTeller.address}`);
    await expectDeployed(maticTeller.address);
    console.log('MATIC teller - init');
    let tx1 = await maticTeller.connect(deployer).initialize(NAME, signerAddress, solace.address, xslocker.address, UNDERWRITING_POOL_ADDRESS, DAO_ADDRESS, WMATIC_ADDRESS, false, bondDepo.address);
    await tx1.wait();
    console.log('MATIC teller - set terms');
    let tx2 = await maticTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('MATIC teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(maticTeller.address);
    await tx3.wait();
    console.log('MATIC teller - set fees');
    let tx4 = await maticTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('MATIC teller - done');
  }
  console.log('MATIC teller - set terms');
  let tx2 = await maticTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
  await tx2.wait();
}

async function deployDaiTeller() {
  const NAME = "Solace DAI Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  const ONE_CENT_IN_DAI = BN.from("10000000000000000");
  const ONE_TENTH_CENT_IN_DAI = BN.from("1000000000000000");

  const START_PRICE = ONE_CENT_IN_DAI.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_DAI; // tenth of a cent in FRAX
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(DAI_BOND_TELLER_ADDRESS)) {
    daiTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, DAI_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("DAI Teller - deploy");
    let tx = await deployer.sendTransaction({to:DEPLOYER_CONTRACT_ADDRESS, gasLimit: 6000000, data:"0x4af63f020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000293d53800000000000000000000000000000000000000000000000000000000000057e160a06040527f137406564cdcf9b40b1700502a9241e87476728da7ae3d0edfcf0541e5b49b3e60805234801561003457600080fd5b5060016000556080516157846200005d600039600081816105890152611d6801526157846000f3fe608060405234801561001057600080fd5b506004361061043c5760003560e01c80635f1c17c0116102355780638a69614e11610135578063c87b56dd116100c8578063dc9451f611610097578063e985e9c51161007c578063e985e9c5146109a0578063ef9089d6146109dc578063f39c38a0146109e657600080fd5b8063dc9451f614610982578063e0176de81461099657600080fd5b8063c87b56dd14610940578063d2da4b4e14610953578063d7ccfb0b14610966578063d83a775b1461096e57600080fd5b8063aa2b9e5511610104578063aa2b9e55146108fe578063abbf4b1714610911578063b88d4fde14610919578063ba5d30781461092c57600080fd5b80638a69614e146108bd57806395d89b41146108d0578063a22cb465146108d8578063a9059cbb146108eb57600080fd5b806376495f27116101c85780637bc90d1c116101975780638456cb591161017c5780638456cb591461088f57806384df61981461089757806388030252146108aa57600080fd5b80637bc90d1c1461087b5780637f386b6c1461088557600080fd5b806376495f271461082e57806378e979251461083c5780637a45df76146108555780637ac2ff7b1461086857600080fd5b80636c0360eb116102045780636c0360eb146107ec57806370a08231146107f457806370fa3ffe14610807578063740112351461081a57600080fd5b80635f1c17c01461072b5780636352211e146107a75780636949faeb146107ba578063695f3f5d146107c457600080fd5b8063389045dd1161034057806344df64c3116102d35780634f6ccce7116102a25780635aa6e675116102875780635aa6e675146106fb5780635c975abb1461070d5780635cfc1a511461072157600080fd5b80634f6ccce7146106de578063586a80bf146106f157600080fd5b806344df64c31461068c57806345fcd13d1461069f5780634ee7b28b146106b85780634f558e79146106cb57600080fd5b80634162169f1161030f5780634162169f146106375780634226d0381461064b578063423f6cef1461066657806342842e0e1461067957600080fd5b8063389045dd146105f35780633d18678e146106085780633ef8d97e1461061b5780633f4ba83a1461062f57600080fd5b8063238efcbc116103d35780632f745c59116103a25780633197cbb6116103875780633197cbb6146105ad57806335659fb8146105e15780633644e515146105eb57600080fd5b80632f745c591461057457806330adf81f1461058757600080fd5b8063238efcbc1461051a57806323b872dd14610522578063268de54c146105355780632ad1a5781461054857600080fd5b80630abb60351161040f5780630abb6035146104be578063141a468c146104d157806318160ddd146104ff5780631c9302211461050757600080fd5b806301ffc9a71461044157806306fdde0314610469578063081812fc1461047e578063095ea7b3146104a9575b600080fd5b61045461044f36600461512c565b6109f8565b60405190151581526020015b60405180910390f35b610471610a23565b604051610460919061551b565b61049161048c366004615113565b610ab5565b6040516001600160a01b039091168152602001610460565b6104bc6104b7366004615057565b610b4f565b005b6104bc6104cc366004614e92565b610c65565b6104f16104df366004615113565b600090815260fe602052604090205490565b604051908152602001610460565b609a546104f1565b61010154600160a01b900460ff16610454565b6104bc610d53565b6104bc610530366004614f68565b610ebe565b61010a5461045490610100900460ff1681565b6101055461055c906001600160801b031681565b6040516001600160801b039091168152602001610460565b6104f1610582366004615057565b610f45565b7f00000000000000000000000000000000000000000000000000000000000000006104f1565b61010a546105cb9068010000000000000000900464ffffffffff1681565b60405164ffffffffff9091168152602001610460565b6104f16101095481565b6104f1610fed565b61010f5461045490600160a01b900460ff1681565b6104bc610616366004615113565b610ffc565b61010d54610491906001600160a01b031681565b6104bc611118565b61011154610491906001600160a01b031681565b6101055461055c90600160801b90046001600160801b031681565b6104bc610674366004615057565b6111e8565b6104bc610687366004614f68565b611207565b6104bc61069a3660046152a4565b611222565b61010a546105cb90600160681b900464ffffffffff1681565b6104bc6106c6366004614ee0565b6115f4565b6104546106d9366004615113565b6116a4565b6104f16106ec366004615113565b6116c3565b6104f161010b5481565b610100546001600160a01b0316610491565b61010a546104549062010000900460ff1681565b6104f16101025481565b610775610739366004615113565b61010c6020526000908152604090208054600182015460028301546003909301549192909164ffffffffff808216916501000000000090041685565b6040805195865260208601949094529284019190915264ffffffffff908116606084015216608082015260a001610460565b6104916107b5366004615113565b611767565b6104f16101075481565b6107d76107d236600461531e565b6117f2565b60408051928352602083019190915201610460565b6104716118c4565b6104f1610802366004614e92565b611952565b6104f16108153660046152f9565b6119ec565b61010e54610491906001600160a01b031681565b61010a546104549060ff1681565b61010a546105cb906301000000900464ffffffffff1681565b6104bc610863366004615166565b611b8a565b6104bc610876366004615081565b611c83565b6104f16101065481565b6104f16101045481565b6104bc6120cf565b6104f16108a53660046152f9565b6121a4565b6104916108b8366004615113565b61233b565b6104bc6108cb366004615113565b6123b8565b610471612623565b6104bc6108e6366004615020565b612632565b6104bc6108f9366004615057565b6126f7565b61049161090c36600461522b565b612702565b6104bc6127a4565b6104bc610927366004614fa4565b6128f8565b61010f54610491906001600160a01b031681565b61047161094e366004615113565b612986565b6107d7610961366004615366565b612ab9565b6104f1612c92565b61011254610491906001600160a01b031681565b61011054610491906001600160a01b031681565b6104f16101085481565b6104546109ae366004614ead565b6001600160a01b039182166000908152606b6020908152604080832093909416825291909152205460ff1690565b6104f16101035481565b610101546001600160a01b0316610491565b60006001600160e01b0319821663780e9d6360e01b1480610a1d5750610a1d82612ccb565b92915050565b606060668054610a3290615642565b80601f0160208091040260200160405190810160405280929190818152602001828054610a5e90615642565b8015610aab5780601f10610a8057610100808354040283529160200191610aab565b820191906000526020600020905b815481529060010190602001808311610a8e57829003601f168201915b5050505050905090565b6000818152606860205260408120546001600160a01b0316610b335760405162461bcd60e51b815260206004820152602c60248201527f4552433732313a20617070726f76656420717565727920666f72206e6f6e657860448201526b34b9ba32b73a103a37b5b2b760a11b60648201526084015b60405180910390fd5b506000908152606a60205260409020546001600160a01b031690565b6000610b5a82611767565b9050806001600160a01b0316836001600160a01b03161415610bc85760405162461bcd60e51b815260206004820152602160248201527f4552433732313a20617070726f76616c20746f2063757272656e74206f776e656044820152603960f91b6064820152608401610b2a565b336001600160a01b0382161480610be45750610be481336109ae565b610c565760405162461bcd60e51b815260206004820152603860248201527f4552433732313a20617070726f76652063616c6c6572206973206e6f74206f7760448201527f6e6572206e6f7220617070726f76656420666f7220616c6c00000000000000006064820152608401610b2a565b610c608383612d1b565b505050565b61010154600160a01b900460ff1615610cb45760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b03163314610cfd5760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b61010180546001600160a01b0319166001600160a01b0383169081179091556040519081527fd61ed858909d3cb796547804c47dc1550d27455f8a0037b6b487e46212392396906020015b60405180910390a150565b61010154600160a01b900460ff1615610da25760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610101546001600160a01b03163314610dfd5760405162461bcd60e51b815260206004820152601360248201527f2170656e64696e6720676f7665726e616e6365000000000000000000000000006044820152606401610b2a565b610101546001600160a01b0316610e565760405162461bcd60e51b815260206004820152600f60248201527f7a65726f20676f7665726e616e636500000000000000000000000000000000006044820152606401610b2a565b610100805461010180546001600160a01b038082166001600160a01b0319808616821790965594909116909155604080519190921680825260208201939093527f5f56bee8cffbe9a78652a74a60705edede02af10b0bbb888ca44b79a0d42ce809101610d48565b610ec83382612d89565b610f3a5760405162461bcd60e51b815260206004820152603160248201527f4552433732313a207472616e736665722063616c6c6572206973206e6f74206f60448201527f776e6572206e6f7220617070726f7665640000000000000000000000000000006064820152608401610b2a565b610c60838383612e80565b6000610f5083611952565b8210610fc45760405162461bcd60e51b815260206004820152602b60248201527f455243373231456e756d657261626c653a206f776e657220696e646578206f7560448201527f74206f6620626f756e64730000000000000000000000000000000000000000006064820152608401610b2a565b506001600160a01b03919091166000908152609860209081526040808320938352929052205490565b6000610ff7612e8b565b905090565b61010154600160a01b900460ff161561104b5760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b031633146110945760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b6127108111156110e65760405162461bcd60e51b815260206004820152601460248201527f696e76616c69642070726f746f636f6c206665650000000000000000000000006044820152606401610b2a565b6101098190556040517f6a116a91f064f00a498d82b291f32259028c1149f5efbf6af24a3645095ea6ae90600090a150565b61010154600160a01b900460ff16156111675760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b031633146111b05760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b61010a805462ff0000191690556040517fa45f47fdea8a1efdd9029a5691c7f759c32b7c698632b563573e155625d1693390600090a1565b611203338383604051806020016040528060008152506128f8565b5050565b610c60838383604051806020016040528060008152506128f8565b61010154600160a01b900460ff16156112715760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b031633146112ba5760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b80356112f85760405162461bcd60e51b815260206004820152600d60248201526c696e76616c696420707269636560981b6044820152606401610b2a565b80356101035560208101356101045560408101356101085561132060a08201608083016152b7565b6001600160801b031661135b5760405162461bcd60e51b81526020600482015260036024820152620312f360ec1b6044820152606401610b2a565b61136b60808201606083016152b7565b61010580546fffffffffffffffffffffffffffffffff19166001600160801b03929092169190911790556113a560a08201608083016152b7565b61010580546001600160801b03928316600160801b02921691909117905560a0810135610102556113dc60e0820160c083016150d9565b61010a805461ff00191661010092151583021790556114029061012083019083016153dc565b64ffffffffff1661141a610100830160e084016153dc565b64ffffffffff16111561146f5760405162461bcd60e51b815260206004820152600d60248201527f696e76616c6964206461746573000000000000000000000000000000000000006044820152606401610b2a565b611480610100820160e083016153dc565b61010a805464ffffffffff9290921663010000000267ffffffffff000000199092169190911790556114ba610120820161010083016153dc565b61010a805464ffffffffff9290921668010000000000000000026cffffffffff0000000000000000199092169190911790556114fe610140820161012083016153dc565b61010a805464ffffffffff92909216600160681b0271ffffffffff00000000000000000000000000199092169190911790556000611544610160830161014084016153dc565b64ffffffffff16116115985760405162461bcd60e51b815260206004820152601060248201527f696e76616c69642068616c666c696665000000000000000000000000000000006044820152606401610b2a565b6115aa610160820161014083016153dc565b64ffffffffff166101065561010a805460ff1916600117905542610107556040517f438cf1acf5a1733b16e518580ad08589e26ce0af89c881c469604df31f27bfd990600090a150565b61010154600160a01b900460ff16156116435760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b0316331461168c5760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b61169b87878787878787612f06565b50505050505050565b6000818152606860205260408120546001600160a01b03161515610a1d565b60006116ce609a5490565b82106117425760405162461bcd60e51b815260206004820152602c60248201527f455243373231456e756d657261626c653a20676c6f62616c20696e646578206f60448201527f7574206f6620626f756e647300000000000000000000000000000000000000006064820152608401610b2a565b609a8281548110611755576117556156fe565b90600052602060002001549050919050565b6000818152606860205260408120546001600160a01b031680610a1d5760405162461bcd60e51b815260206004820152602960248201527f4552433732313a206f776e657220717565727920666f72206e6f6e657869737460448201527f656e7420746f6b656e00000000000000000000000000000000000000000000006064820152608401610b2a565b600080600260005414156118485760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b2a565b6002600090815561185b87878787613256565b9194509250905080156118895761010f5461011154611889916001600160a01b0390811691889116846137df565b61010f54610110546118b3916001600160a01b03908116918891166118ae858c6155ff565b6137df565b506001600055909590945092505050565b60ff80546118d190615642565b80601f01602080910402602001604051908101604052809291908181526020018280546118fd90615642565b801561194a5780601f1061191f5761010080835404028352916020019161194a565b820191906000526020600020905b81548152906001019060200180831161192d57829003601f168201915b505050505081565b60006001600160a01b0382166119d05760405162461bcd60e51b815260206004820152602a60248201527f4552433732313a2062616c616e636520717565727920666f7220746865207a6560448201527f726f2061646472657373000000000000000000000000000000000000000000006064820152608401610b2a565b506001600160a01b031660009081526069602052604090205490565b61010a5460009060ff16611a345760405162461bcd60e51b815260206004820152600f60248201526e1b9bdd081a5b9a5d1a585b1a5e9959608a1b6044820152606401610b2a565b6000611a3e612c92565b905060008111611a7d5760405162461bcd60e51b815260206004820152600a6024820152697a65726f20707269636560b01b6044820152606401610b2a565b80611a9085670de0b6b3a76400006155e0565b611a9a91906155cc565b61010a54909250610100900460ff1615611af95781610102541015611af45760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b611b3f565b83610102541015611b3f5760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b61010854821115611b835760405162461bcd60e51b815260206004820152600e60248201526d626f6e6420746f6f206c6172676560901b6044820152606401610b2a565b5092915050565b600154610100900460ff1680611ba3575060015460ff16155b611c065760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff16158015611c28576001805461ffff19166101011790555b611c318961385f565b60408051808201909152600381526214d09560ea1b6020820152611c558b826139a3565b611c6489898989898989612f06565b508015611c77576001805461ff00191690555b50505050505050505050565b6000858152606860205260409020546001600160a01b0316611ce75760405162461bcd60e51b815260206004820152601b60248201527f717565727920666f72206e6f6e6578697374656e7420746f6b656e00000000006044820152606401610b2a565b83421115611d375760405162461bcd60e51b815260206004820152600e60248201527f7065726d697420657870697265640000000000000000000000000000000000006044820152606401610b2a565b600085815260fe6020526040812080549082611d5283615677565b9190505590506000611d62610fed565b604080517f000000000000000000000000000000000000000000000000000000000000000060208201526001600160a01b038b1691810191909152606081018990526080810184905260a0810188905260c00160405160208183030381529060405280519060200120604051602001611df292919061190160f01b81526002810192909252602282015260420190565b6040516020818303038152906040528051906020012090506000611e1588611767565b9050806001600160a01b0316896001600160a01b03161415611e795760405162461bcd60e51b815260206004820152601560248201527f63616e6e6f74207065726d697420746f2073656c6600000000000000000000006044820152606401610b2a565b803b15611fb157604080516020810187905280820186905260f888901b7fff00000000000000000000000000000000000000000000000000000000000000166060820152815160418183030181526061820192839052630b135d3f60e11b9092526001600160a01b03831691631626ba7e91611ef9918691606501615502565b60206040518083038186803b158015611f1157600080fd5b505afa158015611f25573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611f499190615149565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916631626ba7e60e01b14611fac5760405162461bcd60e51b815260206004820152600c60248201526b1d5b985d5d1a1bdc9a5e995960a21b6044820152606401610b2a565b6120ba565b6040805160008082526020820180845285905260ff891692820192909252606081018790526080810186905260019060a0016020604051602081039080840390855afa158015612005573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b0381166120685760405162461bcd60e51b815260206004820152601160248201527f696e76616c6964207369676e61747572650000000000000000000000000000006044820152606401610b2a565b816001600160a01b0316816001600160a01b0316146120b85760405162461bcd60e51b815260206004820152600c60248201526b1d5b985d5d1a1bdc9a5e995960a21b6044820152606401610b2a565b505b6120c48989612d1b565b505050505050505050565b61010154600160a01b900460ff161561211e5760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b031633146121675760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b61010a805462ff00001916620100001790556040517f9e87fac88ff661f02d44f95383c817fece4bce600a3dab7a54406878b965e75290600090a1565b61010a5460009060ff166121ec5760405162461bcd60e51b815260206004820152600f60248201526e1b9bdd081a5b9a5d1a585b1a5e9959608a1b6044820152606401610b2a565b60006121f6612c92565b9050600081116122355760405162461bcd60e51b815260206004820152600a6024820152697a65726f20707269636560b01b6044820152606401610b2a565b670de0b6b3a764000061224882866155e0565b61225291906155cc565b61010a54909250610100900460ff16156122b157836101025410156122ac5760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b6122f7565b816101025410156122f75760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b61010854841115611b835760405162461bcd60e51b815260206004820152600e60248201526d626f6e6420746f6f206c6172676560901b6044820152606401610b2a565b6000610a1d612348613a8c565b8051602091820120604080517fff00000000000000000000000000000000000000000000000000000000000000818501526bffffffffffffffffffffffff193060601b16602182015260358101879052605580820193909352815180820390930183526075019052805191012090565b6002600054141561240b5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b2a565b600260005580612432816000908152606860205260409020546001600160a01b0316151590565b61247e5760405162461bcd60e51b815260206004820152601b60248201527f717565727920666f72206e6f6e6578697374656e7420746f6b656e00000000006044820152606401610b2a565b6124883383612d89565b6124d45760405162461bcd60e51b815260206004820152600760248201527f21626f6e646572000000000000000000000000000000000000000000000000006044820152606401610b2a565b600082815261010c60209081526040808320815160a081018352815481526001820154938101939093526002810154918301919091526003015464ffffffffff8082166060840152650100000000009091041660808201529061253684613b21565b90508061010c6000868152602001908152602001600020600101600082825461255f9190615594565b90915550506080820151606083015161257891906155ac565b64ffffffffff164211156125c55761258f84613c12565b600084815261010c60205260408120818155600181018290556002810191909155600301805469ffffffffffffffffffff191690555b604080513381526020810183905285917f97f4572ff501a5533a09cf8d7d39be87e303470dd8bc7cff4fe91212be76bc73910160405180910390a261010d54612618906001600160a01b03163383613c28565b505060016000555050565b606060678054610a3290615642565b6001600160a01b03821633141561268b5760405162461bcd60e51b815260206004820152601960248201527f4552433732313a20617070726f766520746f2063616c6c6572000000000000006044820152606401610b2a565b336000818152606b602090815260408083206001600160a01b03871680855290835292819020805460ff191686151590811790915590519081529192917f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a35050565b611203338383610ebe565b600061270d82613c58565b61010d5461010e54610110546101115461011254604051633d22efbb60e11b81529596506001600160a01b0380881696637a45df7696612769968f968f96928516959185169490811693928116928f928f92169060040161552e565b600060405180830381600087803b15801561278357600080fd5b505af1158015612797573d6000803e3d6000fd5b5050505095945050505050565b61010154600160a01b900460ff16156127f35760405162461bcd60e51b815260206004820152601160248201527019dbdd995c9b985b98d9481b1bd8dad959607a1b6044820152606401610b2a565b610100546001600160a01b0316331461283c5760405162461bcd60e51b815260206004820152600b60248201526a21676f7665726e616e636560a81b6044820152606401610b2a565b610101805461010080546001600160a01b036001600160a01b0319909116811790915574ffffffffffffffffffffffffffffffffffffffffff199091167401ffffffffffffffffffffffffffffffffffffffff179091556040805133815260208101929092527f5f56bee8cffbe9a78652a74a60705edede02af10b0bbb888ca44b79a0d42ce80910160405180910390a16040517fd572292b9e5d684b0719ae2d0e210513b477e303c975ed1c63b6fcac1607672790600090a1565b6129023383612d89565b6129745760405162461bcd60e51b815260206004820152603160248201527f4552433732313a207472616e736665722063616c6c6572206973206e6f74206f60448201527f776e6572206e6f7220617070726f7665640000000000000000000000000000006064820152608401610b2a565b61298084848484613c6b565b50505050565b6060816129aa816000908152606860205260409020546001600160a01b0316151590565b6129f65760405162461bcd60e51b815260206004820152601b60248201527f717565727920666f72206e6f6e6578697374656e7420746f6b656e00000000006044820152606401610b2a565b600060ff8054612a0590615642565b80601f0160208091040260200160405190810160405280929190818152602001828054612a3190615642565b8015612a7e5780601f10612a5357610100808354040283529160200191612a7e565b820191906000526020600020905b815481529060010190602001808311612a6157829003601f168201915b5050505050905080612a8f85613cf4565b604051602001612aa0929190615497565b6040516020818303038152906040529250505b50919050565b60008060026000541415612b0f5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610b2a565b600260005561010f54600160a01b900460ff16612b785760405162461bcd60e51b815260206004820152602160248201527f7072696e636970616c20646f6573206e6f7420737570706f7274207065726d696044820152601d60fa1b6064820152608401610b2a565b61010f5460405163d505accf60e01b81526001600160a01b038a81166004830152306024830152604482018d90526064820189905260ff8816608483015260a4820187905260c482018690529091169063d505accf9060e401600060405180830381600087803b158015612beb57600080fd5b505af1158015612bff573d6000803e3d6000fd5b505050506000612c118b8b8b8b613256565b919450925090508015612c3f5761010f5461011154612c3f916001600160a01b03908116918c9116846137df565b612c7d61010f60009054906101000a90046001600160a01b03168a61011060009054906101000a90046001600160a01b0316848f6118ae91906155ff565b50600160005590999098509650505050505050565b6000806101075442612ca491906155ff565b9050612cb36101035482613e0a565b915061010454821015612cc7576101045491505b5090565b60006001600160e01b031982166380ac58cd60e01b1480612cfc57506001600160e01b03198216635b5e139f60e01b145b80610a1d57506301ffc9a760e01b6001600160e01b0319831614610a1d565b6000818152606a6020526040902080546001600160a01b0319166001600160a01b0384169081179091558190612d5082611767565b6001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45050565b6000818152606860205260408120546001600160a01b0316612e025760405162461bcd60e51b815260206004820152602c60248201527f4552433732313a206f70657261746f7220717565727920666f72206e6f6e657860448201526b34b9ba32b73a103a37b5b2b760a11b6064820152608401610b2a565b6000612e0d83611767565b9050806001600160a01b0316846001600160a01b03161480612e485750836001600160a01b0316612e3d84610ab5565b6001600160a01b0316145b80612e7857506001600160a01b038082166000908152606b602090815260408083209388168352929052205460ff165b949350505050565b610c60838383613e5a565b6000610ff77f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f612eba60ca5490565b60cb546040805160208101859052908101839052606081018290524660808201523060a082015260009060c0016040516020818303038152906040528051906020012090509392505050565b6001600160a01b038716612f5c5760405162461bcd60e51b815260206004820152601360248201527f7a65726f206164647265737320736f6c616365000000000000000000000000006044820152606401610b2a565b6001600160a01b038616612fb25760405162461bcd60e51b815260206004820152601560248201527f7a65726f20616464726573732078736c6f636b657200000000000000000000006044820152606401610b2a565b6001600160a01b0385166130085760405162461bcd60e51b815260206004820152601160248201527f7a65726f206164647265737320706f6f6c0000000000000000000000000000006044820152606401610b2a565b6001600160a01b03841661305e5760405162461bcd60e51b815260206004820152601060248201527f7a65726f20616464726573732064616f000000000000000000000000000000006044820152606401610b2a565b6001600160a01b0383166130b45760405162461bcd60e51b815260206004820152601660248201527f7a65726f2061646472657373207072696e636970616c000000000000000000006044820152606401610b2a565b6001600160a01b03811661310a5760405162461bcd60e51b815260206004820152601660248201527f7a65726f206164647265737320626f6e64206465706f000000000000000000006044820152606401610b2a565b61010d80546001600160a01b038981166001600160a01b0319928316811790935561010e8054918a1691909216811790915560405163095ea7b360e01b81526004810191909152600019602482015263095ea7b390604401602060405180830381600087803b15801561317c57600080fd5b505af1158015613190573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906131b491906150f6565b5061011080546001600160a01b038088166001600160a01b031992831617909255610111805487841690831617905561010f8054851515600160a01b0274ffffffffffffffffffffffffffffffffffffffffff19909116878516171790556101128054928416929091169190911790556040517f2cff880e9c762635ec2d7e14018fa7c77831bf16fb33c01dbf332d4663cbe0fb90600090a150505050505050565b600080806001600160a01b0385166132b05760405162461bcd60e51b815260206004820152600f60248201527f696e76616c6964206164647265737300000000000000000000000000000000006044820152606401610b2a565b61010a5462010000900460ff161561330a5760405162461bcd60e51b815260206004820152601b60248201527f63616e6e6f74206465706f736974207768696c652070617573656400000000006044820152606401610b2a565b61010a5460ff1661334f5760405162461bcd60e51b815260206004820152600f60248201526e1b9bdd081a5b9a5d1a585b1a5e9959608a1b6044820152606401610b2a565b61010a546301000000900464ffffffffff164210156133b05760405162461bcd60e51b815260206004820152601460248201527f626f6e64206e6f742079657420737461727465640000000000000000000000006044820152606401610b2a565b61010a5468010000000000000000900464ffffffffff164211156134165760405162461bcd60e51b815260206004820152600e60248201527f626f6e6420636f6e636c756465640000000000000000000000000000000000006044820152606401610b2a565b61341f87614019565b61010a54909350610100900460ff161561348e57610102548381101561347a5760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b61348484826155ff565b61010255506134e5565b61010254878110156134d55760405162461bcd60e51b815260206004820152601060248201526f626f6e6420617420636170616369747960801b6044820152606401610b2a565b6134df88826155ff565b61010255505b610108548311156135295760405162461bcd60e51b815260206004820152600e60248201526d626f6e6420746f6f206c6172676560901b6044820152606401610b2a565b828611156135795760405162461bcd60e51b815260206004820152601360248201527f736c6970706167652070726f74656374696f6e000000000000000000000000006044820152606401610b2a565b61011254604051631d8d9d9160e01b8152600481018590526001600160a01b0390911690631d8d9d9190602401600060405180830381600087803b1580156135c057600080fd5b505af11580156135d4573d6000803e3d6000fd5b5050505083156136a15761010e5461010a546001600160a01b039091169063650e1505908790869061361490600160681b900464ffffffffff1642615594565b6040516001600160e01b031960e086901b1681526001600160a01b03909316600484015260248301919091526044820152606401602060405180830381600087803b15801561366257600080fd5b505af1158015613676573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061369a91906152e0565b91506137b7565b61010b600081546136b190615677565b9182905550915060006136c3426140f2565b61010a546040805160a081018252878152600060208083018281528385018f815264ffffffffff80891660608701908152600160681b9098048116608087018181528d875261010c90955296909420945185559051600185015551600284015593516003909201805494518216650100000000000269ffffffffffffffffffff19909516929091169190911792909217909155909150613763878561416f565b604080518a81526020810187905264ffffffffff8481168284015283166060820152905185917f3a95f02ad5731defc4cdd85d5f55ccc75370529c85a4535e6963b51252cce656919081900360800190a250505b61271061010954886137c991906155e0565b6137d391906155cc565b90509450945094915050565b6040516001600160a01b03808516602483015283166044820152606481018290526129809085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff166001600160e01b031990931692909217909152614179565b600154610100900460ff1680613878575060015460ff16155b6138db5760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff161580156138fd576001805461ffff19166101011790555b6001600160a01b0382166139535760405162461bcd60e51b815260206004820152601760248201527f7a65726f206164647265737320676f7665726e616e63650000000000000000006044820152606401610b2a565b61010080546001600160a01b0319166001600160a01b038416179055610101805474ffffffffffffffffffffffffffffffffffffffffff191690558015611203576001805461ff00191690555050565b600154610100900460ff16806139bc575060015460ff16155b613a1f5760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff16158015613a41576001805461ffff19166101011790555b613a4b838361425e565b613a53614316565b613a7683604051806040016040528060018152602001603160f81b8152506143c9565b8015610c60576001805461ff0019169055505050565b60606040518060400160405280601481526020017f3d602d80600a3d3981f3363d3d373d3d3d363d73000000000000000000000000815250306040518060400160405280600f81526020017f5af43d82803e903d91602b57fd5bf30000000000000000000000000000000000815250604051602001613b0d9392919061544b565b604051602081830303815290604052905090565b600081815261010c60209081526040808320815160a0810183528154808252600183015494820185905260028301549382019390935260039091015464ffffffffff808216606084015265010000000000909104166080820152911115613b8a57613b8a6156a6565b80608001518160600151613b9e91906155ac565b64ffffffffff164211613bfa578060200151816080015164ffffffffff16826060015164ffffffffff1642613bd391906155ff565b8351613bdf91906155e0565b613be991906155cc565b613bf391906155ff565b9150612ab3565b60208101518151613c0b91906155ff565b9392505050565b6000613c1d82611767565b90506112038261449a565b6040516001600160a01b038316602482015260448101829052610c6090849063a9059cbb60e01b90606401613813565b6000610a1d613c65613a8c565b83614541565b613c76848484612e80565b613c82848484846145e3565b6129805760405162461bcd60e51b815260206004820152603260248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201527f63656976657220696d706c656d656e74657200000000000000000000000000006064820152608401610b2a565b606081613d185750506040805180820190915260018152600360fc1b602082015290565b8160005b8115613d425780613d2c81615677565b9150613d3b9050600a836155cc565b9150613d1c565b60008167ffffffffffffffff811115613d5d57613d5d615714565b6040519080825280601f01601f191660200182016040528015613d87576020820181803683370190505b5090505b8415612e7857613d9c6001836155ff565b9150613da9600a86615692565b613db4906030615594565b60f81b818381518110613dc957613dc96156fe565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350613e03600a866155cc565b9450613d8b565b60006101065482613e1b91906155cc565b610106549084901c9150600290613e328185615692565b613e3c90846155e0565b613e4691906155cc565b613e5091906155cc565b613c0b90826155ff565b826001600160a01b0316613e6d82611767565b6001600160a01b031614613ee95760405162461bcd60e51b815260206004820152602960248201527f4552433732313a207472616e73666572206f6620746f6b656e2074686174206960448201527f73206e6f74206f776e00000000000000000000000000000000000000000000006064820152608401610b2a565b6001600160a01b038216613f4b5760405162461bcd60e51b8152602060048201526024808201527f4552433732313a207472616e7366657220746f20746865207a65726f206164646044820152637265737360e01b6064820152608401610b2a565b613f56838383614746565b613f61600082612d1b565b6001600160a01b0383166000908152606960205260408120805460019290613f8a9084906155ff565b90915550506001600160a01b0382166000908152606960205260408120805460019290613fb8908490615594565b909155505060008181526068602052604080822080546001600160a01b0319166001600160a01b0386811691821790925591518493918716917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4505050565b600080610107544261402b91906155ff565b9050600061403c6101035483613e0a565b90506101045481101561404f5750610104545b8061408c5760405162461bcd60e51b815260206004820152600d60248201526c696e76616c696420707269636560981b6044820152606401610b2a565b4261010755806140a485670de0b6b3a76400006155e0565b6140ae91906155cc565b610105549093506001600160801b03600160801b82048116916140d29116856155e0565b6140dc91906155cc565b6140e69082615594565b61010355509092915050565b6000650100000000008210612cc75760405162461bcd60e51b815260206004820152602660248201527f53616665436173743a2076616c756520646f65736e27742066697420696e203460448201527f30206269747300000000000000000000000000000000000000000000000000006064820152608401610b2a565b61120382826147fe565b60006141ce826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b031661494c9092919063ffffffff16565b805190915015610c6057808060200190518101906141ec91906150f6565b610c605760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f742073756363656564000000000000000000000000000000000000000000006064820152608401610b2a565b600154610100900460ff1680614277575060015460ff16155b6142da5760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff161580156142fc576001805461ffff19166101011790555b614304614316565b61430c614316565b613a76838361495b565b600154610100900460ff168061432f575060015460ff16155b6143925760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff161580156143b4576001805461ffff19166101011790555b80156143c6576001805461ff00191690555b50565b600154610100900460ff16806143e2575060015460ff16155b6144455760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff16158015614467576001805461ffff19166101011790555b825160208085019190912083519184019190912060ca9190915560cb558015610c60576001805461ff0019169055505050565b60006144a582611767565b90506144b381600084614746565b6144be600083612d1b565b6001600160a01b03811660009081526069602052604081208054600192906144e79084906155ff565b909155505060008281526068602052604080822080546001600160a01b0319169055518391906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908390a45050565b60008260200183518381836000f5925050506001600160a01b0381166145a95760405162461bcd60e51b815260206004820152601c60248201527f436c6f6e6561626c653a206661696c6564206465706c6f796d656e74000000006044820152606401610b2a565b6040516001600160a01b038216907f8ffcdc15a283d706d38281f500270d8b5a656918f555de0913d7455e3e6bc1bf90600090a292915050565b60006001600160a01b0384163b1561473b57604051630a85bd0160e11b81526001600160a01b0385169063150b7a02906146279033908990889088906004016154c6565b602060405180830381600087803b15801561464157600080fd5b505af1925050508015614671575060408051601f3d908101601f1916820190925261466e91810190615149565b60015b614721573d80801561469f576040519150601f19603f3d011682016040523d82523d6000602084013e6146a4565b606091505b5080516147195760405162461bcd60e51b815260206004820152603260248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201527f63656976657220696d706c656d656e74657200000000000000000000000000006064820152608401610b2a565b805181602001fd5b6001600160e01b031916630a85bd0160e11b149050612e78565b506001949350505050565b6001600160a01b0383166147a15761479c81609a80546000838152609b60205260408120829055600182018355919091527f44da158ba27f9252712a74ff6a55c5d531f69609f1f6e7f17c4443a8e2089be40155565b6147c4565b816001600160a01b0316836001600160a01b0316146147c4576147c48382614a37565b6001600160a01b0382166147db57610c6081614ad4565b826001600160a01b0316826001600160a01b031614610c6057610c608282614b83565b6001600160a01b0382166148545760405162461bcd60e51b815260206004820181905260248201527f4552433732313a206d696e7420746f20746865207a65726f20616464726573736044820152606401610b2a565b6000818152606860205260409020546001600160a01b0316156148b95760405162461bcd60e51b815260206004820152601c60248201527f4552433732313a20746f6b656e20616c7265616479206d696e746564000000006044820152606401610b2a565b6148c560008383614746565b6001600160a01b03821660009081526069602052604081208054600192906148ee908490615594565b909155505060008181526068602052604080822080546001600160a01b0319166001600160a01b03861690811790915590518392907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908290a45050565b6060612e788484600085614bc7565b600154610100900460ff1680614974575060015460ff16155b6149d75760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610b2a565b600154610100900460ff161580156149f9576001805461ffff19166101011790555b8251614a0c906066906020860190614d3f565b508151614a20906067906020850190614d3f565b508015610c60576001805461ff0019169055505050565b60006001614a4484611952565b614a4e91906155ff565b600083815260996020526040902054909150808214614aa1576001600160a01b03841660009081526098602090815260408083208584528252808320548484528184208190558352609990915290208190555b5060009182526099602090815260408084208490556001600160a01b039094168352609881528383209183525290812055565b609a54600090614ae6906001906155ff565b6000838152609b6020526040812054609a8054939450909284908110614b0e57614b0e6156fe565b9060005260206000200154905080609a8381548110614b2f57614b2f6156fe565b6000918252602080832090910192909255828152609b9091526040808220849055858252812055609a805480614b6757614b676156e8565b6001900381819060005260206000200160009055905550505050565b6000614b8e83611952565b6001600160a01b039093166000908152609860209081526040808320868452825280832085905593825260999052919091209190915550565b606082471015614c3f5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c00000000000000000000000000000000000000000000000000006064820152608401610b2a565b843b614c8d5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610b2a565b600080866001600160a01b03168587604051614ca9919061542f565b60006040518083038185875af1925050503d8060008114614ce6576040519150601f19603f3d011682016040523d82523d6000602084013e614ceb565b606091505b5091509150614cfb828286614d06565b979650505050505050565b60608315614d15575081613c0b565b825115614d255782518084602001fd5b8160405162461bcd60e51b8152600401610b2a919061551b565b828054614d4b90615642565b90600052602060002090601f016020900481019282614d6d5760008555614db3565b82601f10614d8657805160ff1916838001178555614db3565b82800160010185558215614db3579182015b82811115614db3578251825591602001919060010190614d98565b50612cc79291505b80821115612cc75760008155600101614dbb565b600067ffffffffffffffff80841115614dea57614dea615714565b604051601f8501601f19908116603f01168101908282118183101715614e1257614e12615714565b81604052809350858152868686011115614e2b57600080fd5b858560208301376000602087830101525050509392505050565b80356001600160a01b0381168114614e5c57600080fd5b919050565b600082601f830112614e7257600080fd5b613c0b83833560208501614dcf565b803560ff81168114614e5c57600080fd5b600060208284031215614ea457600080fd5b613c0b82614e45565b60008060408385031215614ec057600080fd5b614ec983614e45565b9150614ed760208401614e45565b90509250929050565b600080600080600080600060e0888a031215614efb57600080fd5b614f0488614e45565b9650614f1260208901614e45565b9550614f2060408901614e45565b9450614f2e60608901614e45565b9350614f3c60808901614e45565b925060a0880135614f4c8161572a565b9150614f5a60c08901614e45565b905092959891949750929550565b600080600060608486031215614f7d57600080fd5b614f8684614e45565b9250614f9460208501614e45565b9150604084013590509250925092565b60008060008060808587031215614fba57600080fd5b614fc385614e45565b9350614fd160208601614e45565b925060408501359150606085013567ffffffffffffffff811115614ff457600080fd5b8501601f8101871361500557600080fd5b61501487823560208401614dcf565b91505092959194509250565b6000806040838503121561503357600080fd5b61503c83614e45565b9150602083013561504c8161572a565b809150509250929050565b6000806040838503121561506a57600080fd5b61507383614e45565b946020939093013593505050565b60008060008060008060c0878903121561509a57600080fd5b6150a387614e45565b955060208701359450604087013593506150bf60608801614e81565b92506080870135915060a087013590509295509295509295565b6000602082840312156150eb57600080fd5b8135613c0b8161572a565b60006020828403121561510857600080fd5b8151613c0b8161572a565b60006020828403121561512557600080fd5b5035919050565b60006020828403121561513e57600080fd5b8135613c0b81615738565b60006020828403121561515b57600080fd5b8151613c0b81615738565b60008060008060008060008060006101208a8c03121561518557600080fd5b893567ffffffffffffffff81111561519c57600080fd5b6151a88c828d01614e61565b9950506151b760208b01614e45565b97506151c560408b01614e45565b96506151d360608b01614e45565b95506151e160808b01614e45565b94506151ef60a08b01614e45565b93506151fd60c08b01614e45565b925060e08a013561520d8161572a565b915061521c6101008b01614e45565b90509295985092959850929598565b600080600080600060a0868803121561524357600080fd5b853567ffffffffffffffff81111561525a57600080fd5b61526688828901614e61565b95505061527560208701614e45565b935061528360408701614e45565b925060608601356152938161572a565b949793965091946080013592915050565b60006101608284031215612ab357600080fd5b6000602082840312156152c957600080fd5b81356001600160801b0381168114613c0b57600080fd5b6000602082840312156152f257600080fd5b5051919050565b6000806040838503121561530c57600080fd5b82359150602083013561504c8161572a565b6000806000806080858703121561533457600080fd5b843593506020850135925061534b60408601614e45565b9150606085013561535b8161572a565b939692955090935050565b600080600080600080600080610100898b03121561538357600080fd5b883597506020890135965061539a60408a01614e45565b955060608901356153aa8161572a565b9450608089013593506153bf60a08a01614e81565b925060c0890135915060e089013590509295985092959890939650565b6000602082840312156153ee57600080fd5b813564ffffffffff81168114613c0b57600080fd5b6000815180845261541b816020860160208601615616565b601f01601f19169290920160200192915050565b60008251615441818460208701615616565b9190910192915050565b6000845161545d818460208901615616565b606085901b6bffffffffffffffffffffffff1916908301908152835161548a816014840160208801615616565b0160140195945050505050565b600083516154a9818460208801615616565b8351908301906154bd818360208801615616565b01949350505050565b60006001600160a01b038087168352808616602084015250836040830152608060608301526154f86080830184615403565b9695505050505050565b828152604060208201526000612e786040830184615403565b602081526000613c0b6020830184615403565b60006101208083526155428184018d615403565b6001600160a01b039b8c166020850152998b16604084015250509588166060870152938716608086015291861660a0850152851660c0840152151560e083015290921661010090920191909152919050565b600082198211156155a7576155a76156bc565b500190565b600064ffffffffff8083168185168083038211156154bd576154bd6156bc565b6000826155db576155db6156d2565b500490565b60008160001904831182151516156155fa576155fa6156bc565b500290565b600082821015615611576156116156bc565b500390565b60005b83811015615631578181015183820152602001615619565b838111156129805750506000910152565b600181811c9082168061565657607f821691505b60208210811415612ab357634e487b7160e01b600052602260045260246000fd5b600060001982141561568b5761568b6156bc565b5060010190565b6000826156a1576156a16156d2565b500690565b634e487b7160e01b600052600160045260246000fd5b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fd5b80151581146143c657600080fd5b6001600160e01b0319811681146143c657600080fdfea26469706673582212206bfbec7c312f11ea6b278e46a489d14fe25a13b5736a25a5870a4eac70cf6ac864736f6c6343000806003300000000000000000000000000000000000000000000000000000000000000"});
    await tx.wait(10);
    daiTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, DAI_BOND_TELLER_ADDRESS)) as BondTellerErc20;
    console.log(`DAI Teller - deployed to ${daiTeller.address}`);
    await expectDeployed(daiTeller.address);
    console.log('DAI teller - init');
    let tx1 = await daiTeller.connect(deployer).initialize(NAME, signerAddress, solace.address, xslocker.address, UNDERWRITING_POOL_ADDRESS, DAO_ADDRESS, DAI_ADDRESS, false, bondDepo.address);
    await tx1.wait();
    console.log('DAI teller - set terms');
    let tx2 = await daiTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('DAI teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(daiTeller.address);
    await tx3.wait();
    console.log('DAI teller - set fees');
    let tx4 = await daiTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('DAI teller - done');
  }
}

async function deployEthTeller() {
  const NAME = "Solace ETH Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  const ONE_CENT_IN_ETH = BN.from("3968253968253"); // @ 1 eth = $2520
  const ONE_TENTH_CENT_IN_ETH = BN.from("396825396825");

  const START_PRICE = ONE_CENT_IN_ETH.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_ETH; // tenth of a cent in DAI
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(WETH_BOND_TELLER_ADDRESS)) {
    wethTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, WETH_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("WETH Teller - deploy");
    var salt = "0x0000000000000000000000000000000000000000000000000000000003ba0308";
    wethTeller = await cloneTeller(daiTeller, NAME, WETH_ADDRESS, false, salt);
    console.log(`WETH Teller - deployed to ${wethTeller.address}`);
    await expectDeployed(wethTeller.address);
    console.log('WETH teller - set terms');
    let tx2 = await wethTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('WETH teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(wethTeller.address);
    await tx3.wait();
    console.log('WETH teller - set fees');
    let tx4 = await wethTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('WETH teller - done');
  }
}

async function deployUsdcTeller() {
  const NAME = "Solace USDC Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  const ONE_CENT_IN_USDC = BN.from("10000");
  const ONE_TENTH_CENT_IN_USDC = BN.from("1000");

  const START_PRICE = ONE_CENT_IN_USDC.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_USDC; // tenth of a cent in DAI
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(USDC_BOND_TELLER_ADDRESS)) {
    usdcTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, USDC_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("USDC Teller - deploy");
    var salt = "0x00000000000000000000000000000000000000000000000000000000019004c0";
    usdcTeller = await cloneTeller(daiTeller, NAME, USDC_ADDRESS, true, salt);
    console.log(`USDC Teller - deployed to ${usdcTeller.address}`);
    console.log('USDC Teller - set terms');
    let tx2 = await usdcTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('USDC teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(usdcTeller.address);
    await tx3.wait();
    console.log('USDC Teller - set fees');
    let tx4 = await usdcTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('USDC Teller - done');
  }
}

async function deployWbtcTeller() {
  const NAME = "Solace WBTC Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days

  const ONE_DOLLAR_IN_WBTC = BN.from("2697"); // @ BTC = $37077
  const TEN_CENTS_IN_WBTC = BN.from("269");

  const START_PRICE = ONE_DOLLAR_IN_WBTC.mul(8).div(100); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_DOLLAR_IN_WBTC.div(10); // ten cents in DAI
  const PRICE_ADJ_DENOM = BN.from("5000000000000000000000000"); //  5000,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(WBTC_BOND_TELLER_ADDRESS)) {
    wbtcTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, WBTC_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("WBTC Teller - deploy");
    var salt = "0x0000000000000000000000000000000000000000000000000000000001f0cd1b";
    wbtcTeller = await cloneTeller(daiTeller, NAME, WBTC_ADDRESS, false, salt);
    console.log(`WBTC Teller - deployed to ${wbtcTeller.address}`);
    console.log('WBTC Teller - set terms');
    let tx2 = await wbtcTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('WBTC teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(wbtcTeller.address);
    await tx3.wait();
    console.log('WBTC Teller - set fees');
    let tx4 = await wbtcTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('WBTC Teller - done');
  }
}

async function deployUsdtTeller() {
  const NAME = "Solace USDT Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  const ONE_CENT_IN_USDT = BN.from("10000");
  const ONE_TENTH_CENT_IN_USDT = BN.from("1000");

  const START_PRICE = ONE_CENT_IN_USDT.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_USDT; // tenth of a cent in USDT
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;

  if(await isDeployed(USDT_BOND_TELLER_ADDRESS)) {
    usdtTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, USDT_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("USDT Teller - deploy");
    var salt = "0x0000000000000000000000000000000000000000000000000000000002153a56";
    usdtTeller = await cloneTeller(daiTeller, NAME, USDT_ADDRESS, false, salt);
    console.log(`USDT Teller - deployed to ${usdtTeller.address}`);
    console.log('USDT Teller - set terms');
    let tx2 = await usdtTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('USDT teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(usdtTeller.address);
    await tx3.wait();
    console.log('USDT Teller - set fees');
    let tx4 = await usdtTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('USDT Teller - done');
  }
}

async function deployFraxTeller() {
  const NAME = "Solace FRAX Bond";
  //const VESTING_TERM = 604800; // 7 days
  const VESTING_TERM = 600; // 10 minutes
  const HALF_LIFE = 2592000; // 30 days
  const ONE_CENT_IN_FRAX = BN.from("10000000000000000");
  const ONE_TENTH_CENT_IN_FRAX = BN.from("1000000000000000");

  const START_PRICE = ONE_CENT_IN_FRAX.mul(8); // 8 cents
  const MAX_PAYOUT = BN.from("10000000000000000000000000") // 10 million SOLACE max single bond
  const CAPACITY = BN.from("100000000000000000000000000"); // 100 million SOLACE max over lifetime
  // every 50,000 SOLACE bonded raises the price one tenth of a cent
  const PRICE_ADJ_NUM = ONE_TENTH_CENT_IN_FRAX; // tenth of a cent in FRAX
  const PRICE_ADJ_DENOM = BN.from("50000000000000000000000"); // 50,000 SOLACE
  if(PRICE_ADJ_NUM.gt(MAX_UINT128) || PRICE_ADJ_DENOM.gt(MAX_UINT128)) throw `Uint128 too large: ${PRICE_ADJ_NUM.toString()} | ${PRICE_ADJ_DENOM.toString()} > ${MAX_UINT128.toString()}`;


  if(await isDeployed(FRAX_BOND_TELLER_ADDRESS)) {
    fraxTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, FRAX_BOND_TELLER_ADDRESS)) as BondTellerErc20;
  } else {
    console.log("FRAX Teller - deploy");
    var salt = "0x0000000000000000000000000000000000000000000000000000000002e3569f";
    fraxTeller = await cloneTeller(daiTeller, NAME, FRAX_ADDRESS, false, salt);
    console.log(`FRAX Teller - deployed to ${fraxTeller.address}`);
    console.log('FRAX Teller - set terms');
    let tx2 = await fraxTeller.connect(deployer).setTerms({startPrice: START_PRICE, minimumPrice: START_PRICE, maxPayout: MAX_PAYOUT, priceAdjNum: PRICE_ADJ_NUM, priceAdjDenom: PRICE_ADJ_DENOM, capacity: CAPACITY, capacityIsPayout: true, startTime: BOND_START_TIME, endTime: MAX_UINT40, globalVestingTerm: VESTING_TERM, halfLife: HALF_LIFE}, {gasLimit: 300000});
    await tx2.wait();
    console.log('FRAX teller - add to bond depo');
    let tx3 = await bondDepo.connect(deployer).addTeller(fraxTeller.address);
    await tx3.wait();
    console.log('FRAX Teller - set fees');
    let tx4 = await fraxTeller.connect(deployer).setFees(500);
    await tx4.wait();
    console.log('FRAX Teller - done');
  }
}

async function cloneTeller(sourceTeller: BondTellerErc20, name: string, principal: string, isPermittable: boolean, salt: BytesLike) {
  let addr = await sourceTeller.calculateMinimalProxyDeploymentAddress(salt);
  console.log(`cloning ${sourceTeller.address} to ${addr}`);
  await sourceTeller.clone(name, signerAddress, principal, isPermittable, salt, {gasLimit: 500000});
  let newTeller = (await ethers.getContractAt(artifacts.BondTellerERC20.abi, addr)) as BondTellerErc20;
  return newTeller;
}

async function deployTestnetTokens() {
  console.log(`Deploying WMATIC`);
  let wmatic = await deployContract(deployer, artifacts.WMATIC);
  console.log(`Deployed to ${wmatic.address}`);

  let tokens: any[] = [
    {name: "Wrapped Ether", symbol: "WETH", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false},
    //{name: "Dai Stablecoin", symbol: "DAI", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false},
    //{name: "USD Coin", symbol: "USDC", supply: BN.from("1000000000"), decimals: 6, permit: true},
    //{name: "Wrapped Bitcoin", symbol: "WBTC", supply: BN.from("1000000000"), decimals: 8, permit: false},
    //{name: "USD Token", symbol: "USDT", supply: BN.from("1000000000"), decimals: 6, permit: false},
    //{name: "Frax", symbol: "FRAX", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false},
  ];
  for(var i = 0; i < tokens.length; ++i) {
    let token = tokens[i];
    console.log(`Deploying ${token.symbol}`);
    let artifact = token.permit ? artifacts.MockERC20Permit : artifacts.MockERC20Decimals;
    let tokenContract = await deployContract(deployer, artifact, [token.name, token.symbol, token.supply, token.decimals]);
    console.log(`Deployed to ${tokenContract.address}`);
  }

}

async function mintTestnetTokens() {
  /*
  let weth = await ethers.getContractAt(artifacts.WMATIC.abi, WETH_ADDRESS);
  console.log('start eth balance');
  console.log(await provider.getBalance(signerAddress));
  console.log('start weth balance');
  console.log(await weth.balanceOf(signerAddress));
  console.log('wrapping eth')
  let tx1 = await weth.connect(deployer).deposit({value: ONE_ETHER.div(1000)});
  await tx1.wait();
  console.log('end eth balance');
  console.log(await provider.getBalance(signerAddress));
  console.log('end weth balance');
  console.log(await weth.balanceOf(signerAddress));
  */
  let tokens: any[] = [
    {name: "Wrapped Ether", symbol: "WETH", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false, address: WETH_ADDRESS},
    //{name: "Dai Stablecoin", symbol: "DAI", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false, address: DAI_ADDRESS},
    //{name: "USD Coin", symbol: "USDC", supply: BN.from("1000000000"), decimals: 6, permit: true, address: USDC_ADDRESS},
    //{name: "Wrapped Bitcoin", symbol: "WBTC", supply: BN.from("1000000000"), decimals: 8, permit: false, address: WBTC_ADDRESS},
    //{name: "USD Token", symbol: "USDT", supply: BN.from("1000000000"), decimals: 6, permit: false, address: USDT_ADDRESS},
    //{name: "Frax", symbol: "FRAX", supply: ONE_ETHER.mul(1000000), decimals: 18, permit: false, address: FRAX_ADDRESS},
  ];
  let recipients = ["0x34Bb9e91dC8AC1E13fb42A0e23f7236999e063D4", "0x1271e2acD0d209FA490692F5578239583Cde4073", "0xfb5cAAe76af8D3CE730f3D62c6442744853d43Ef"];
  wmatic = (await ethers.getContractAt(artifacts.WMATIC.abi, WMATIC_ADDRESS)) as Wmatic;
  //let tx1 = await wmatic.deposit({value: ONE_ETHER});
  //await tx1.wait(5);
  for(var j = 0; j < recipients.length; ++j) {
    let recipient = recipients[j];
    let tx2 = await wmatic.transfer(recipient, ONE_ETHER.div(4));
    await tx2.wait(5);

    for(var i = 0; i < tokens.length; ++i) {
      let token = tokens[i];
      let artifact = token.permit ? artifacts.MockERC20Permit : artifacts.MockERC20Decimals;
      let tokenContract = await ethers.getContractAt(artifact.abi, token.address);
      console.log(`Minting ${token.symbol}`);
      let bal1 = await tokenContract.balanceOf(signerAddress);
      let tx1 = await tokenContract.connect(deployer).mint();
      await tx1.wait();
      let bal2 = await tokenContract.balanceOf(signerAddress);
      console.log(`Transferring ${token.symbol}`);
      let tx2 = await tokenContract.connect(deployer).transfer(recipient, bal2.sub(bal1));
      await tx2.wait();

      console.log(`Checking balance of ${token.symbol}`);
      console.log(await tokenContract.balanceOf(recipient));
    }
    /*
    console.log('Minting SOLACE');
    let tx3 = await solace.connect(deployer).mint(recipient, ONE_ETHER.mul(1000));
    await tx3.wait()
    console.log('Checking balance of SOLACE');
    console.log(await solace.balanceOf(recipient));
    */
  }
}

async function logAddresses() {
  console.log("");
  console.log("| Contract Name                | Address                                      |");
  console.log("|------------------------------|----------------------------------------------|");
  logContractAddress("SOLACE", solace.address);
  logContractAddress("xsLocker", xslocker.address);
  logContractAddress("BondDepository", bondDepo.address);
  logContractAddress("MATIC Bond Teller", maticTeller.address);
  logContractAddress("WETH Bond Teller", wethTeller.address);
  logContractAddress("DAI Bond Teller", daiTeller.address);
  logContractAddress("USDC Bond Teller", usdcTeller.address);
  logContractAddress("WBTC Bond Teller", wbtcTeller.address);
  logContractAddress("USDT Bond Teller", usdtTeller.address);
  logContractAddress("FRAX Bond Teller", fraxTeller.address);
  logContractAddress("WMATIC", WMATIC_ADDRESS);
  logContractAddress("WETH", WETH_ADDRESS);
  logContractAddress("DAI", DAI_ADDRESS);
  logContractAddress("USDC", USDC_ADDRESS);
  logContractAddress("WBTC", WBTC_ADDRESS);
  logContractAddress("USDT", USDT_ADDRESS);
  logContractAddress("FRAX", FRAX_ADDRESS);
}

main()
    .then(() => process.exit(0))
    .catch(error => {
        console.error(error);
        process.exit(1);
  });
